#!/usr/bin/env bash

HERE="$(dirname ${BASH_SOURCE[0]})"
PATH="$HERE/google-cloud-sdk/bin:$PATH"

find $HERE -name gcloud

while true ; do
  gcloud compute instances list --format json | \
    jq -r '.[] | select(.status == "TERMINATED") | .name' | \
    xargs gcloud compute instances delete \
      --zone ${GCLOUD_ZONE:-us-central1-f} \
      --verbosity ${GCLOUD_VERBOSITY:-debug} \
      -q \
      --log-http ${GCLOUD_LOG_HTTP:-true}
  sleep ${GCLOUD_CLEANUP_LOOP_SLEEP:-10}
done
